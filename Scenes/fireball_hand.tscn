[gd_scene load_steps=24 format=3 uid="uid://cmt7lyxs0n1fy"]

[ext_resource type="Shader" uid="uid://bf3cbuknktrmk" path="res://Scripts/Spells/Shaders/fireheader_shader.tres" id="2_b1hm7"]
[ext_resource type="Material" uid="uid://buq12rxemvbkf" path="res://Resources/Models/Resource/mat_firetrail1.tres" id="3_y3fmr"]
[ext_resource type="Script" uid="uid://1tr367dqgdt5" path="res://Scripts/Spells/Trail3D.gd" id="4_70vjv"]
[ext_resource type="Material" uid="uid://osm40gk0a5v0" path="res://Addons/effects/fireball/materials/fireball_fire_particles_mat.tres" id="10_lfo07"]

[sub_resource type="SphereShape3D" id="SphereShape3D_thgck"]

[sub_resource type="ShaderMaterial" id="ShaderMaterial_t2on5"]
render_priority = 0
shader = ExtResource("2_b1hm7")
shader_parameter/Ball_Color = Color(0.9372549, 0.6627451, 0.20392157, 1)
shader_parameter/Frensnel_Power = 5.0

[sub_resource type="SphereMesh" id="SphereMesh_xhx2f"]

[sub_resource type="ImmediateMesh" id="ImmediateMesh_a0ivi"]

[sub_resource type="Gradient" id="Gradient_wb2op"]
colors = PackedColorArray(1, 1, 1, 1, 1, 1, 1, 0)

[sub_resource type="GradientTexture1D" id="GradientTexture1D_7l2i5"]
gradient = SubResource("Gradient_wb2op")

[sub_resource type="Curve" id="Curve_4ma6n"]
_data = [Vector2(0, 0), 0.0, 0.0, 0, 0, Vector2(0.4, 1), 0.0, 0.0, 0, 0, Vector2(1, 0.8), 0.0, 0.0, 0, 0]
point_count = 3

[sub_resource type="CurveTexture" id="CurveTexture_og8y2"]
curve = SubResource("Curve_4ma6n")

[sub_resource type="ParticleProcessMaterial" id="ParticleProcessMaterial_uvc4n"]
lifetime_randomness = 0.4
emission_shape = 1
emission_sphere_radius = 0.15
direction = Vector3(0, 0, -1)
spread = 20.0
initial_velocity_min = 1.0
initial_velocity_max = 2.0
gravity = Vector3(0, 1, 0)
scale_min = 0.39999998
scale_max = 0.59999996
scale_curve = SubResource("CurveTexture_og8y2")
color_ramp = SubResource("GradientTexture1D_7l2i5")
anim_speed_min = 0.1
anim_speed_max = 0.1
anim_offset_max = 1.0

[sub_resource type="QuadMesh" id="QuadMesh_jeop1"]
size = Vector2(0.5, 0.5)

[sub_resource type="Shader" id="Shader_q1xb5"]
code = "shader_type spatial;
render_mode unshaded, ambient_light_disabled;

uniform sampler2D voronoi_sampler : filter_linear_mipmap, repeat_enable;

varying float id;
varying vec4 custom;

void vertex() {

	mat4 mat_world = mat4(normalize(INV_VIEW_MATRIX[0]), normalize(INV_VIEW_MATRIX[1]) ,normalize(INV_VIEW_MATRIX[2]), MODEL_MATRIX[3]);
	mat_world = mat_world * mat4(vec4(cos(INSTANCE_CUSTOM.x), -sin(INSTANCE_CUSTOM.x), 0.0, 0.0), vec4(sin(INSTANCE_CUSTOM.x), cos(INSTANCE_CUSTOM.x), 0.0, 0.0), vec4(0.0, 0.0, 1.0, 0.0), vec4(0.0, 0.0, 0.0, 1.0));
	MODELVIEW_MATRIX = VIEW_MATRIX * mat_world;
	MODELVIEW_MATRIX = MODELVIEW_MATRIX * mat4(vec4(length(MODEL_MATRIX[0].xyz), 0.0, 0.0, 0.0),vec4(0.0, length(MODEL_MATRIX[1].xyz), 0.0, 0.0), vec4(0.0, 0.0, length(MODEL_MATRIX[2].xyz), 0.0), vec4(0.0, 0.0, 0.0, 1.0));
	MODELVIEW_NORMAL_MATRIX = mat3(MODELVIEW_MATRIX);

	id = float(INSTANCE_ID);
	custom = INSTANCE_CUSTOM;
}

void fragment() {
	float voronoi = texture(voronoi_sampler, UV * 0.3 + id * 0.1 + custom.b).x;
	float dist = distance(UV, vec2(0.5));
	float dist_mask = smoothstep(0.45, 0.0, dist);
	float mask = max(0.0, dist_mask - voronoi);
	ALBEDO = COLOR.rgb;
	ALPHA = custom.y * mask * COLOR.a;
}
"

[sub_resource type="FastNoiseLite" id="FastNoiseLite_t2on5"]
noise_type = 2
fractal_octaves = 2

[sub_resource type="NoiseTexture2D" id="NoiseTexture2D_excd7"]
noise = SubResource("FastNoiseLite_t2on5")
seamless = true

[sub_resource type="ShaderMaterial" id="ShaderMaterial_xhx2f"]
render_priority = 0
shader = SubResource("Shader_q1xb5")
shader_parameter/voronoi_sampler = SubResource("NoiseTexture2D_excd7")

[sub_resource type="Gradient" id="Gradient_ex6o2"]
colors = PackedColorArray(1, 1, 1, 1, 1, 1, 1, 0)

[sub_resource type="GradientTexture1D" id="GradientTexture1D_ottve"]
gradient = SubResource("Gradient_ex6o2")

[sub_resource type="Curve" id="Curve_pbov0"]
_data = [Vector2(0, 0.5), 0.0, 0.0, 0, 0, Vector2(0.8, 1), 0.0, 0.0, 0, 0]
point_count = 2

[sub_resource type="CurveTexture" id="CurveTexture_078xr"]
curve = SubResource("Curve_pbov0")

[sub_resource type="ParticleProcessMaterial" id="ParticleProcessMaterial_srp83"]
lifetime_randomness = 0.1
emission_shape = 1
emission_sphere_radius = 0.15
direction = Vector3(0, 0, -1)
spread = 20.0
gravity = Vector3(0, 1, 0)
scale_min = 0.8
scale_max = 1.2
scale_curve = SubResource("CurveTexture_078xr")
color = Color(0.780392, 0.780392, 0.780392, 0.470588)
color_ramp = SubResource("GradientTexture1D_ottve")
anim_speed_min = 0.01
anim_speed_max = 0.02
anim_offset_max = 1.0

[node name="Fireball" type="Area3D"]
transform = Transform3D(0.25, 0, 0, 0, 0.25, 0, 0, 0, 0.25, 0, 0, 0)
collision_layer = 4
collision_mask = 2

[node name="CollisionShape3D" type="CollisionShape3D" parent="."]
shape = SubResource("SphereShape3D_thgck")
disabled = true

[node name="VFX_Fireball" type="Node3D" parent="."]

[node name="FireballHeadMesh" type="MeshInstance3D" parent="VFX_Fireball"]
transform = Transform3D(0.65, 0, 0, 0, 0.65, 0, 0, 0, 0.65, 0, 0, 0)
material_override = SubResource("ShaderMaterial_t2on5")
mesh = SubResource("SphereMesh_xhx2f")
skeleton = NodePath("../..")

[node name="Trail3D" type="MeshInstance3D" parent="VFX_Fireball"]
transform = Transform3D(9.553427e-16, 2.1855694e-08, 0.5, 0.5, -2.1855694e-08, 0, 2.1855694e-08, 0.5, -2.1855694e-08, 0, 0, 0)
material_override = ExtResource("3_y3fmr")
mesh = SubResource("ImmediateMesh_a0ivi")
skeleton = NodePath("../..")
script = ExtResource("4_70vjv")
fromWidth = 1.0
toWidth = 1.0
lifespan = 0.25
startColor = Color(1.1801987, 0.38287753, 0, 1)
endColor = Color(0.8981444, 0.29836166, 1.3061791e-06, 0.873)

[node name="FireTrail" type="GPUParticles3D" parent="."]
unique_name_in_owner = true
material_override = ExtResource("10_lfo07")
amount = 16
lifetime = 0.5
process_material = SubResource("ParticleProcessMaterial_uvc4n")
draw_pass_1 = SubResource("QuadMesh_jeop1")

[node name="FireSmoke" type="GPUParticles3D" parent="."]
unique_name_in_owner = true
material_override = SubResource("ShaderMaterial_xhx2f")
amount = 16
explosiveness = 0.2
process_material = SubResource("ParticleProcessMaterial_srp83")
draw_pass_1 = SubResource("QuadMesh_jeop1")
